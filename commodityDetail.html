{% extends "base.html" %}

{% block title %}
    CommodityDetail
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/subNavbar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/commodityDetail.css') }}">
{% endblock %}

{% block content %}
    <div class="subNavbarContainer">
        <div class="subNavbarLeftBox">
            <a class="subNavbarTitle" id="Apparel" href="{{ url_for('tagApparel') }}">
                <en>Apparel</en>
                <cn>服饰</cn>
            </a>
            <a class="subNavbarTitle" id="Stationery" href="{{ url_for('tagStationery') }}">
                <en>Stationery</en>
                <cn>文具</cn>
            </a>
            <a class="subNavbarTitle" id="DailyUse" href="{{ url_for('tagDailyUse') }}">
                <en>Daily Use</en>
                <cn>日用品</cn>
            </a>
            <a class="subNavbarTitle" id="Sports" href="{{ url_for('tagSports') }}">
                <en>Sports</en>
                <cn>运动</cn>
            </a>
            <a class="subNavbarTitle" id="Gift" href="{{ url_for('tagGift') }}">
                <en>Gift</en>
                <cn>礼品</cn>
            </a>
            <a class="subNavbarTitle" id="Gift" href="{{ url_for('aboutUs') }}">
                <en>About Us</en>
                <cn>关于我们</cn>
            </a>
        </div>
        <div class="subNavbarRightBox">
            <a class="subNavbarTitle" onclick="history.back();">
                <en>Back</en>
                <cn>返回</cn>
            </a>
        </div>
    </div>

    <div class="detailContainer">
        <div class="detailBox">
            <div class="detailPicBox">
                <img src="{{ url_for('static', filename='pic/commodity/'~commodity.pic~'_1.png') }}" alt=""
                     class="detailPic">
                <img src="{{ url_for('static', filename='pic/commodity/'~commodity.pic~'_2.png') }}" alt=""
                     class="detailPic">
                <img src="{{ url_for('static', filename='pic/commodity/'~commodity.pic~'_3.png') }}" alt=""
                     class="detailPic">
                <div class="detailPicArrow detailPicLeft" id="left">&#10094;</div>
                <div class="detailPicArrow detailPicRight" id="right">&#10095;</div>
            </div>
        </div>
        <div class="detailBox">
            <div class="detailCommodityBox">
                <p class="detailTitle">
                    {{ commodity.name|safe }}
                </p>
                <p class="detailInfo">
                    <en style="white-space: nowrap">Description:&nbsp;</en>
                    <cn style="white-space: nowrap">描述：</cn>
                    {{ commodity.intro|safe }}</p>
                <p class="detailInfo" id="repertory"></p>
                <hr class="detailHr">
                <p class="detailPrice">{{ commodity.price }}CNY</p>
                <hr class="detailHr">
                {% if commodity.isOnsale %}
                    <div class="detailOptionBox" id="option">
                        {% if commodity.tag == "apparel" %}
                            <div class="detailOptionMark">?</div>
                            <div class="detailOptionToolTip">
                                <p>
                                    <cn>S码：建议身高160cm及以下</cn>
                                    <en>Size S: Recommended for heights below 160 cm
                                    </en>
                                </p>
                                <p>
                                    <cn>M码：建议身高160-170cm</cn>
                                    <en>Size M: Recommended for heights 160-170 cm
                                    </en>
                                </p>
                                <p>
                                    <cn>L码：建议身高165-175cm</cn>
                                    <en>Size L: Recommended for heights 165-175 cm
                                    </en>
                                </p>
                                <p>
                                    <cn>XL码：建议身高175cm以上</cn>
                                    <en>Size XL: Recommended for heights above 175 cm
                                    </en>
                                </p>
                            </div>
                        {% endif %}
                    </div>
                    <hr class="detailHr">
                    <div class="detailAmountBox">
                        <div class="detailAmountBtn" id="minus">&minus;</div>
                        <label for="number"></label>
                        <input type="number" class="detailAmountInput" value="1" min="0"
                               max="{{ commodity.repertory }}" id="number">
                        <div class="detailAmountBtn" id="plus">&plus;</div>
                    </div>
                    <div class="detailBtnBox">
                        <button class="detailCartBtn" onclick="upload({{ commodity.id }})">
                            <en>Add to Cart</en>
                            <cn>加入购物车</cn>
                        </button>
                    </div>
                    <div class="detailSoldOutBox">
                        <p>
                            <en>Products are currently sold out</en>
                            <cn>产品目前已售罄</cn>
                        </p>
                        <small>
                            <en>You may buy the next batch.</en>
                            <cn>你可以购买下一批货</cn>
                        </small>
                    </div>
                {% else %}
                    <div class="detailNotOnSaleBox">
                        <p>
                            <en>This product is no longer available</en>
                            <cn>产品目前已下架</cn>
                        </p>
                        <small>
                            <en>Contact with us for more information</en>
                            <cn>联系我们以获得更多信息</cn>
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function decodeHtmlEntities(str) {
            const txt = document.createElement("textarea");
            txt.innerHTML = str;
            return txt.value;
        }

        let elements = document.querySelectorAll('.detailPic');
        const minusButton = document.getElementById("minus");
        const plusButton = document.getElementById("plus");
        const numberInput = document.getElementById("number");
        const left = document.getElementById("left");
        const right = document.getElementById("right");
        const range = [0, -102, -204];
        let mode = 0;

        const repertory = JSON.parse({{ commodity.option | tojson | safe }});
        const optionElement = document.getElementById('option');
        const titleElement = document.getElementById('title');
        const repertoryElement = document.getElementById('repertory');
        const amountBox = document.getElementsByClassName('detailAmountBox')[0];
        const btnBox = document.getElementsByClassName('detailBtnBox')[0];
        const soldOutBox = document.getElementsByClassName('detailSoldOutBox')[0];
        let maximum = 1;
        let selectedKey;

        let idleTimer;

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                right.click();
            }, 7500);
        }

        left.addEventListener("click", function () {
            mode = (mode + 2) % 3;
            elements.forEach(function (element) {
                element.style.left = range[mode] + '%';
            });
            resetIdleTimer();
        });

        right.addEventListener("click", function () {
            mode = (mode + 1) % 3;
            elements.forEach(function (element) {
                element.style.left = range[mode] + '%';
            });
            resetIdleTimer();
        });

        setTimeout(() => {
            right.click();
        }, 2500);

        for (const key in repertory) {
            if (repertory.hasOwnProperty(key)) {
                const div = document.createElement('div');
                div.innerHTML = key;
                div.dataset.key = key;
                div.classList.add('option');
                optionElement.insertBefore(div, optionElement.firstChild);
            }
        }

        const firstOption = optionElement.querySelector('.option');
        if (firstOption) {
            setRepertory(firstOption);
        }

        optionElement.addEventListener('click', (event) => {
            if (event.target.classList.contains('option')) {
                const selected = optionElement.querySelector('.selected');
                if (selected) {
                    selected.classList.remove('selected');
                }
                setRepertory(event.target);
            }
        });

        function setValue(value = parseInt(numberInput.value)) {
            if (value < 1) {
                numberInput.value = 1;
            } else if (value > maximum) {
                numberInput.value = maximum;
            } else {
                numberInput.value = value;
            }
        }

        function setRepertory(target) {
            target.classList.add('selected');
            selectedKey = target.dataset.key;
            maximum = repertory[selectedKey];

            repertoryElement.innerHTML = "<en>Repertory:&nbsp;</en><cn>库存：</cn>" + maximum;
            setValue();
            if (maximum < 1) {
                amountBox.style.display = "none";
                btnBox.style.display = "none";
                soldOutBox.style.display = "flex";
            } else {
                amountBox.style.display = "flex";
                btnBox.style.display = "flex";
                soldOutBox.style.display = "none";
            }
        }

        minusButton.addEventListener("click", function () {
            setValue(parseInt(numberInput.value) - 1);
        });

        plusButton.addEventListener("click", function () {
            setValue(parseInt(numberInput.value) + 1);
        });

        numberInput.addEventListener('keydown', function (event) {
            if (event.key === '.') {
                event.preventDefault();
            }
        });

        numberInput.addEventListener("input", function () {
            setValue();
        });

        function upload(id) {
            const currentValue = parseInt(numberInput.value);
            const addToCartButton = document.querySelector(".detailCartBtn");

            if (maximum === 0) {
                announce("<en>Products you choose are currently sold out</en><cn>所选商品暂时售空</cn>");
                return;
            }
            if (isNaN(currentValue) || currentValue > maximum || currentValue < 1) {
                numberInput.value = 1;
            }

            addToCartButton.disabled = true;
            addToCartButton.innerHTML = "<en>Loading...</en><cn>加载中······</cn>";

            const data = {
                commodityId: id,
                option: selectedKey,
                quantity: parseInt(numberInput.value)
            };

            let whetherReload;

            fetch('{{ url_for("addCart") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    whetherReload = response.status === 404;
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        announce(data.error);
                        if (whetherReload) {
                            setTimeout(function () {
                                location.reload();
                            }, 1500);
                        }
                    } else {
                        announce(data.message, "#75a35b");
                        const cartElement = document.getElementById("cart");
                        if (cartElement) {
                            cartElement.click();
                        }
                    }
                })
                .catch(() => {
                    announce('<en>An unexpected error occurred</en><cn>发生意外错误</cn>');
                    setTimeout(function () {
                        location.reload();
                    }, 1500);
                })
                .finally(() => {
                    addToCartButton.disabled = false;
                    addToCartButton.innerHTML = "<en>Add to Cart</en><cn>加入购物车</cn>";
                });
        }
    </script>
{% endblock %}
