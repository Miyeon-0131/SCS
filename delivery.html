<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交付人员管理订单</title>
    <style>
        table {
            border: 2px solid #000;
        }

        th, td {
            border: 2px solid #999;
        }
    </style>
    <script>
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('lastFailed')) {
                alert("提交更改订单状态失败");
            }
        };

        function showCodePrompt(form) {
            const code = prompt("请输入取件码（三位数）：", "");
            if (code && /^[0-9]{1,3}$/.test(code)) {
                const hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "code";
                hiddenInput.value = code;
                form.appendChild(hiddenInput);
                form.submit();
            } else {
                alert("请输入有效的三位数取件码。");
            }
        }
    </script>
</head>
<body>
<div class="container mt-5">
    <h1>交付人员管理订单</h1>
    <button onclick="window.location='{{ url_for('home') }}'">返回首页</button>
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>订单ID</th>
            <th>用户姓名</th>
            <th>用户邮箱</th>
            <th>购物车项</th>
            <th>总金额</th>
            <th>订单状态</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        {% for order in orders %}
            <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.user.name }}</td>
                <td>{{ order.user.email }}</td>
                <td>
                    <ul>
                        {% for cart in order.carts %}
                            <li>
                                <span>{{ cart.commodity.name|safe }}</span> - 选项: {{ cart.option }} -
                                数量: {{ cart.quantity }} - 单价{{ cart.commodity.price }}
                            </li>
                        {% endfor %}
                    </ul>
                </td>
                <td>{{ order.price }}</td>
                <td>
                    {% if order.state == 0 %}
                        初始
                    {% elif order.state == 3 %}
                        部分发货
                    {% endif %}
                </td>
                <td>
                    <form method="POST" onsubmit="event.preventDefault(); showCodePrompt(this);">
                        <input type="hidden" name="orderId" value="{{ order.id }}">
                        <label>
                            <select name="state" required>
                                <option value="">选择新的状态</option>
                                <option value="0">初始状态</option>
                                <option value="1">取消订单</option>
                                <option value="2">交易成功</option>
                                <option value="3">部分发货</option>
                            </select>
                        </label>
                        <button type="submit" class="btn btn-primary">更新状态</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
</body>
</html>